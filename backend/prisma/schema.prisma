// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  passwordHash  String        @map("password_hash")
  name          String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tickets       Ticket[]
  ticketStates  TicketState[]
  employees     Employee[]
  reports       DailyReport[]
  backups       Backup[]
  summaries     Summary[]

  @@map("users")
}

model Ticket {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  name        String
  price       Float
  bookSize    Int      @map("book_size")
  orderIndex  Int      @default(0) @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketState TicketState?
  ticketDetails TicketDetail[]

  @@unique([userId, name])
  @@map("tickets")
}

model TicketState {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  ticketId    Int      @unique @map("ticket_id")
  lastNumber  Int      @map("last_number")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([userId, ticketId])
  @@map("ticket_states")
}

model Employee {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("employees")
}

model DailyReport {
  id          String      @id @default(cuid())
  userId      String      @map("user_id")
  date        DateTime    @db.Date
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  shiftData   ShiftData[]

  @@unique([userId, date])
  @@map("daily_reports")
}

model ShiftData {
  id                    String         @id @default(cuid())
  reportId              String         @map("report_id")
  shiftType             String         @map("shift_type") // 'A' or 'B'
  personName            String?        @map("person_name")
  onlineSales           Float          @default(0) @map("online_sales")
  onlineCashes          Float          @default(0) @map("online_cashes")
  instantCashes         Float          @default(0) @map("instant_cashes")
  actualCash            Float          @default(0) @map("actual_cash")
  totalScratchSales     Float          @default(0) @map("total_scratch_sales")
  expectedScratchCash   Float          @default(0) @map("expected_scratch_cash")
  totalExpectedCash     Float          @default(0) @map("total_expected_cash")
  difference            Float          @default(0)
  dataEntered           Boolean        @default(false) @map("data_entered")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  report                DailyReport    @relation(fields: [reportId], references: [id], onDelete: Cascade)
  ticketDetails         TicketDetail[]

  @@unique([reportId, shiftType])
  @@map("shift_data")
}

model TicketDetail {
  id          String     @id @default(cuid())
  shiftDataId String    @map("shift_data_id")
  ticketId    Int       @map("ticket_id")
  prevNum     Int       @map("prev_num")
  currentNum  Int       @map("current_num")
  soldCount   Int       @map("sold_count")
  totalAmount Float     @map("total_amount")
  createdAt   DateTime  @default(now()) @map("created_at")

  shiftData   ShiftData @relation(fields: [shiftDataId], references: [id], onDelete: Cascade)
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_details")
}

model Backup {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  backupData  Json     @map("backup_data")
  backupType  String   @map("backup_type") // 'auto' or 'manual'
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("backups")
}

model Summary {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  periodType  String   @map("period_type") // 'daily', 'weekly', 'monthly', 'custom'
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  summaryData Json     @map("summary_data")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

